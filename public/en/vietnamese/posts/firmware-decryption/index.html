<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Nam Nguyễn">
<meta name="description" content="Phá mã phần mềm điều khiển của thiết bị NPort W2150A" />
<meta name="keywords" content="homepage, blog, bảo mật, hack, dịch ngược, lập trình" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://namberino.github.io/en/vietnamese/posts/firmware-decryption/" />


    <title>
        
            Phá mã phần mềm điều khiển của jack cắm kết nối WiFi :: Nam&#39;s Journal 
        
    </title>





<link rel="stylesheet" href="/main.f328c18cc29e8f38ea9856605ac2b3d52498b99bcd296a7867e57a6cd4ba1ec8.css" integrity="sha256-8yjBjMKejzjqmFZgWsKz1SSYuZvNKWp4Z&#43;V6bNS6Hsg=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="Phá mã phần mềm điều khiển của jack cắm kết nối WiFi">
  <meta itemprop="description" content="Phá mã phần mềm điều khiển của thiết bị NPort W2150A">
  <meta itemprop="datePublished" content="2024-04-26T12:02:12+07:00">
  <meta itemprop="dateModified" content="2024-04-26T12:02:12+07:00">
  <meta itemprop="wordCount" content="2889">
  <meta itemprop="image" content="https://namberino.github.io/">
  <meta itemprop="keywords" content="Bảo Mật,Hack,Dịch Ngược,Lập Trình">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://namberino.github.io/">
  <meta name="twitter:title" content="Phá mã phần mềm điều khiển của jack cắm kết nối WiFi">
  <meta name="twitter:description" content="Phá mã phần mềm điều khiển của thiết bị NPort W2150A">



    <meta property="og:url" content="https://namberino.github.io/en/vietnamese/posts/firmware-decryption/">
  <meta property="og:site_name" content="Nam&#39;s Journal">
  <meta property="og:title" content="Phá mã phần mềm điều khiển của jack cắm kết nối WiFi">
  <meta property="og:description" content="Phá mã phần mềm điều khiển của thiết bị NPort W2150A">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="vietnamese">
    <meta property="article:published_time" content="2024-04-26T12:02:12+07:00">
    <meta property="article:modified_time" content="2024-04-26T12:02:12+07:00">
    <meta property="article:tag" content="Bảo Mật">
    <meta property="article:tag" content="Hack">
    <meta property="article:tag" content="Dịch Ngược">
    <meta property="article:tag" content="Lập Trình">
    <meta property="og:image" content="https://namberino.github.io/">






    <meta property="article:published_time" content="2024-04-26 12:02:12 &#43;0700 &#43;07" />













<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>


    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                nam$journal</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/en/about/">About</a></li><li><a href="/en/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
                <span class="theme-toggle not-selectable" style="margin-left: 1.5rem; margin-right: 1rem;">
	
        
            
            <a class="active language" style="text-decoration: underline;"> EN </a>
            
                <div style="margin-left: 0.12rem; margin-right: 0.12rem;"> | </div>
            
        
	
        
            
            
        
	

</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://namberino.github.io/en/vietnamese/posts/firmware-decryption/">Phá mã phần mềm điều khiển của jack cắm kết nối WiFi</a></h2>

            
            
            

            <div class="post-content">
                <p>Mình đã học dịch ngược, hệ thống nhúng và phần mềm điều khiển hệ thống nhúng khá lâu rồi. Dạo gần đây mình lại nghĩ &ldquo;Sao mình không kết hợp 2 kĩ năng này để làm 1 cái gì đấy hay?&rdquo;. Thế nên mình thử sức bản thân bằng cách phá mã của 1 phần mềm điều khiển đã được mã hóa của 1 jack cắm kết nối WiFi. Mình đã ghi lại quá trình phá mã và cách suy nghĩ của mình trong bài blog này.</p>
<h1 id="về-thiết-bị">Về thiết bị</h1>
<p>Gần đây mình cũng đọc được 1 lỗ hổng trong thiết bị jack cắm <a href="https://www.moxa.com/en/products/industrial-edge-connectivity/serial-device-servers/wireless-device-servers/nport-w2150a-w2250a-series"><em>Moxa NPort W2150A Serial-To-Wifi</em></a>, lỗ hổng này sử dụng buffer overflow dạng stack. Xong mình nghĩ là mình cũng muốn thử làm 1 dự án liên quan đến bên bảo mật cho thiết bị này. Bởi vì thiết bị này có phần mềm đã được mã hóa, mình quyết định sẽ cố phá mã để có thể lấy được mã nguồn của phần mềm điều khiển.</p>
<p>Mình muốn bắt đầu với 1 phiên bản cũ hơn của phần mềm điều khiển của thiết bị này. Mình tìm được phiên bản <a href="https://www.moxa.com/Moxa/media/PDIM/S100000210/moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom"><em>v2.2</em></a>, được xuất bản vào khoảng 2019. MÌnh sẽ sử dụng phiên bản này.</p>
<h1 id="phân-tích-phần-mềm">Phân tích phần mềm</h1>
<p>Đầu tiên mình muốn thử trích xuất tất cả thông tin về phần mềm điều khiển này trước khi mình dịch ngược.</p>
<p>Mình thử sử dụng câu lệnh <code>file</code> để xem nó có thể phát hiện được phần mềm <code>.rom</code>  này là phần mềm loại gì không:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ file moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom
</span></span><span style="display:flex;"><span>moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom: data
</span></span></code></pre></div><p><code>data</code> có nghĩa là câu lệnh <code>file</code> không thể phát hiện dấu hiệu của bất kì định dạng file nào phần mềm <code>.rom</code> này. Điều này có nghĩa là phần mềm này đã được mã hóa khá kĩ càng.</p>
<p>Mình thử chạy câu lệnh <code>hexdump</code> để xem cấu trúc của phần mềm này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hexdump -C moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom | head
</span></span></code></pre></div>
    <img src="/img/nport-firmware/nport-firmware-hexdump.png"  alt="hexdump phần mềm điều khiển"  class="center"  style="padding: 10px"  />


<p>Ở đầu phần mềm này là <code>NPW2X50A8k</code>. Đây là tên của thiết bị. Sau đó là 1 vài byte null dùng để lấp chỗ trống. Sau đó là các byte nhìn rất random. Mình cũng không trích xuất được nhiều thông tin từ đây.</p>
<p>Since we can&rsquo;t really find anything using <code>file</code> and <code>hexdump</code>, let&rsquo;s use a more powerful tool. I&rsquo;ll use <code>binwalk</code> as that tool allows me to walk through the entire binary and find file signatures and compression methods. The tool also provides extensive binary analysis tools. Bởi vì mình không tìm được nhiều thông tin qua các câu lệnh <code>file</code> và <code>hexdump</code>, mình sẽ sử dụng công cụ mạnh hơn. Mình dùng <code>binwalk</code>, công cụ này cho phép mình &ldquo;bước&rdquo; qua cả file nhị phân và tìm các định dạng file và các định dạng nén trong phần mềm. Câu lệnh này cũng có nhiều công cụ phân tích nhị phân khác nhau.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>binwalk moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom
</span></span></code></pre></div><p>Khi mình chạy câu lệnh <code>binwalk</code> trên, mình được kết quả là 1 file <code>MySQL</code>. Đây là 1 báo động giả bởi vì mình không nghĩ là 1 jack cắm kết nối WiFi sẽ cần sử dụng database. Thế mình cũng không có thông tin gì hữu ích.</p>
<p>Sau đó thì mình bắt đầu tìm các phiên bản cũ hơn để xem mình có thể trích xuất thông tin gì từ đó. Trong khi mình đang đọc <a href="https://www.moxa.com/Moxa/media/PDIM/S100000210/W2250A%20Series_moxa-nport-w2150a-w2250a-series-firmware-1.11.rom_Software%20Release%20History.pdf">note xuất bản</a> của phiên bản <em>1.11</em>, mình tìm thấy 1 phần khá thú vị:</p>

    <img src="/img/nport-firmware/nport-firmware-version11-release-note.png"  alt="Note xuất bản phiên bản 1.11"  class="center"  style="padding: 10px"  />


<p>Phiên bản <em>1.11</em> là phiên bản tiên quyết cho phiên bản <em>2.2</em>. Tức là mình cần phiên bản <em>1.11</em> để có thể tải phiên bản <em>2.2</em>. Mình nghĩ là phần mã hóa cho phần mềm điều khiển được thêm vào trong phiên bản <em>2.2</em>. Thế nên mình đã tải phiên bản <a href="https://www.moxa.com/Moxa/media/PDIM/S100000210/moxa-nport-w2150a-w2250a-series-firmware-1.11.rom">v1.11</a> và bắt đầu phân tích phiên bản này.</p>
<p>Đầu tiên mình thử <code>binwalk</code> phiên bản này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>binwalk moxa-nport-w2150a-w2250a-series-firmware-1.11.rom
</span></span></code></pre></div>
    <img src="/img/nport-firmware/nport-firmware-older-version-binwalk.png"  alt="NPort firmware phiên bản 1.11 binwalk"  class="center"  style="padding: 10px"  />


<p>Output này xác nhận là phiên bản <em>1.11</em> không bị mã hóa. Trong output này có 2 điều khá thú vị: 2 hệ thống file <code>squashfs</code> đã được nén bằng <code>gzip</code>. <code>squashfs</code> là cả 1 hệ thống file của Linux.</p>
<p>Mình sẽ thử giải nén phần mềm này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>binwalk -e moxa-nport-w2150a-w2250a-series-firmware-1.11.rom
</span></span></code></pre></div><p>Câu lệnh này sẽ giải nén phiên bản <em>1.11</em> vào tệp <code>_moxa-nport-w2150a-w2250a-series-firmware-1.11.rom.extracted</code>:</p>

    <img src="/img/nport-firmware/nport-firmware-extracted-screenshot.png"  alt="NPort firmware phiên bản 1.11 giải nén"  class="center"  style="padding: 10px"  />


<p>Trong folder đó có các folder con <code>squashfs-root</code>, các folder này có hệ thống file Linux của phần mềm này. Trước khi mình truy cập folder này thì mình cần phân quyền đúng cho folder đó:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x -R squashfs-root*
</span></span></code></pre></div><p>Giờ mình có thể truy cập các folder <code>squashfs-root</code>:</p>

    <img src="/img/nport-firmware/nport-firmware-old-version-filesystem.png"  alt="NPort firmware phiên bản 1.11 hệ thống file đã được giải nén"  class="center"  style="padding: 10px"  />


<p>Sau khi nhìn qua các folder trong phần mềm này, mình tìm được 1 file có tên là <code>libupgradeFirmware.so</code> trong folder <code>lib</code> của folder <code>squashfs-root</code>. Bởi vì phiên bản <em>2.2</em> cần có phiên bản <em>1.11</em>, mình đoán là file <code>libupgradeFirmware.so</code> sẽ có thông tin về các phần mềm này đã được mã hóa. Mình sẽ phân tích và dịch ngược file nhị phân này:</p>
<h1 id="dịch-ngược-file-libupgradefirmwareso">Dịch ngược file <strong>libupgradeFirmware.so</strong></h1>
<p>Mình sẽ dùng <a href="https://ghidra-sre.org/"><code>Ghidra</code></a> để dịch ngược.</p>
<p>Đầu tiên mình sẽ xem các hàm có trong file nhị phân này:</p>

    <img src="/img/nport-firmware/nport-firmware-ghidra-function-window.png"  alt="NPort firmware Ghidra các hàm"  class="center"  style="padding: 10px"  />


<p>File này có sử dụng thuật toán mã hóa khối <strong>AES</strong> ở chế độ <strong>ECB</strong> (Electronic Code Block). Bởi vì chế độ <strong>ECB</strong> tạo text mã hóa (ciphertext) giống nhau với text thường (plaintext) giống nhau, hacker có thể suy ra khóa bí mật và phá mã dữ liệu đã được mã hóa bằng chế độ <strong>ECB</strong>. Đây là 1 lỗ hổng lớn mà mình có thể tấn công.</p>

    <img src="/img/nport-firmware/nport-firmware-ghidra-fw_decrypt.png"  alt="NPort firmware Ghidra các hàm, hàm fw_decrypt"  class="center"  style="padding: 10px"  />


<p>Firmware này cũng có hàm <code>fw_decrypt</code>. Đây chắc là 1 hàm dùng để giải mã firmware, hàm này chắc là 1 hàm khá quan trọng. Mình sẽ xem hàm <code>fw_decrypt</code> này có gọi hàm nào khác không:</p>

    <img src="/img/nport-firmware/nport-firmware-fw_decrypt-call-graph.png"  alt="NPort firmware fw_decrypt graph hàm gọi"  class="center"  style="padding: 10px"  />


<p><code>fw_decrypt</code> gọi 3 hàm khác nhau: <code>cal_crc32</code> (hàm này được dùng cho checksum và đảm bảo tính toàn vẹn của dữ liệu), <code>memcpy</code> (copy bộ nhớ), và <code>ecb128Decrypt</code> (đây chắc là hàm giải mã AES 128 ở chế độ ECB).</p>
<p>Mình sẽ check các hàm mà <code>ecb128Decrypt</code> gọi bởi để xem nó hoạt động thế nào:</p>

    <img src="/img/nport-firmware/nport-firmware-ecb128decrypt-call-graph.png"  alt="NPort firmware ecb128Decrypt graph hàm gọi"  class="center"  style="padding: 10px"  />


<p>Hàm này gọi các hàm AES trong thư viện <em>OpenSSL</em>. Mình có thể dùng công cụ của <em>OpenSSL</em> để giải mã phần mềm firmware này. Nhưng mình sẽ cần khóa dùng cho việc mã hóa phần mềm này để có thể giải mã nó.</p>
<h1 id="dịch-ngược-hàm-ecb128decrypt">Dịch ngược hàm ecb128Decrypt</h1>
<p>Mình sẽ bắt đầu dịch ngược hàm <code>ecb128Decrypt</code> này:</p>

    <img src="/img/nport-firmware/nport-firmware-ecb128decrypt-function-reversed.png"  alt="NPort firmware ecb128Decrypt hàm dịch ngược"  class="center"  style="padding: 10px"  />


<p>Trong lúc phân tích mình sẽ đặt tên lại và đặt kiểu dữ liệu lại cho các biến trong phần mềm firmware này.</p>
<p>Mình sẽ bắt đầu với hàm AES. Hàm <code>AES_set_decrypt_key</code> sẽ có input là khóa người dùng và mở rộng nó ra thành 1 khóa AES. Hàm <code>AES_set_decrypt_key</code> này sẽ sử dụng biến <code>auStack_30</code>. Trong <a href="https://www.openssl.org/docs/">tài liệu chính thức của OpenSSL</a>, input đầu tiên của hàm này là khóa người dùng. Thế nên mình có thể đặt tên<code>auStack_30</code> thành <code>user_key</code>. <code>AStack_124</code> là khóa AES thế nên mình sẽ đặt tên nó thành <code>aes_key</code>. Khóa AES này sẽ được sử dụng cho việc giải mã phần mềm.</p>
<p>Hàm này cũng cần lấy 1 tham số là kích cỡ khóa. Trong chương trình này thì kích cỡ khóa là <em>0x80</em> (là <em>128</em> trong số nguyên). Tức là firmware này sử dụng khóa AES với kích cỡ khóa là <em>128-bit</em>. Mình sẽ đổi kiểu dữ liệu của <em>0x80</em> thành số nguyên.</p>
<p>Tiếp theo, trên hàn <code>strncpy</code>, dòng này đang copy 16 byte từ <code>param_4</code> sang <code>auStack_30</code> (khóa người dùng <code>user_key</code>). Tức là <code>param_4</code> là 1 khóa giải mã bởi vì <code>user_key</code> sẽ được sử dụng trong hàm giải mã AES. Mình sẽ đặt tên cho biến <code>param_4</code> thành <code>decrypt_key</code>.</p>
<p>Tiếp theo, ở dòng có biến <code>in</code> and <code>out</code>, các biến này có chứa dữ liệu của <code>param_1</code> và <code>param_2</code> và các dữ liệu này được cộng với sai số là <em>0x10</em> (<em>16</em> trong số nguyên). 2 biến này cũng được cho vào hàm <code>AES_ecb_encrypt</code>.</p>
<p>Hàm <code>AES_ecb_encrypt</code> sẽ cần 1 buffer đầu vào, 1 buffer đầu ra, 1 khóa AES và chế độ mã hóa. Bởi vì hàm <code>AES_ecb_encrypt</code> có chế độ mã hóa 0 ở trường hợp này, hàm <code>AES_ecb_encrypt</code> sẽ được đặt vào chế độ giải mã. Thế hàm này sẽ giải mã dữ liệu trong buffer đầu vào dùng khóa AES và cho dữ liệu đã được giải mã vào buffer đầu ra.</p>
<p>Mình suy ra là biến <code>param_1</code> và <code>param_2</code> là buffer đầu vào và buffer đầu ra. Mình sẽ đặt tên <code>param_1</code> thành <code>decrypt_in</code> và <code>param_2</code> thành <code>decrypt_out</code> và đổi kiễu dữ liệu thành <code>uchar*</code> bởi vì biến <code>in</code> và <code>out</code> đều là <code>uchar*</code>.</p>
<p>Tiếp theo, biến <code>iVar1</code> biến đếm được dùng cho vòng lặp, vòng lặp này chỉ dừng khi biến đếm bằng <code>param_3 + -0x28</code>. Thế nên <code>param_3</code> sẽ là kích cỡ của buffer đầu vào. Mình sẽ đặt tên <code>param_3</code> thành <code>decrypt_size</code>. <code>decrypt_size</code> cần được cộng với sai số là <code>-0x28</code>, điều này có nghĩa là file này sẽ có 1 vài byte đệm ở đầu file. Lúc mình dùng <code>hexdump</code>, mình tìm được 1 vài byte <code>00</code> ở đầu file, đó chắc là lý do tại sao <code>decrypt_size</code> cần được cộng với sai số <em>-0x28</em> (40 byte)</p>
<p>Đây là hàm đã được đặt tên lại:</p>

    <img src="/img/nport-firmware/nport-firmware-ecb128decrypt-reversed-renamed.png"  alt="NPort firmware ecb128Decrypt hàm đã được đặt tên lại"  class="center"  style="padding: 10px"  />


<p>Thế là mình đã hiểu được cách hàm <code>ecb128Decrypt</code> hoạt động: Nó lấy 1 buffer đầu vào (<code>decrypt_in</code>), giải mã nó với khóa (<code>decrypt_key</code>), và cho kết quả vào đầu ra (<code>decrypt_out</code>).</p>
<h1 id="dịch-ngược-hàm-fw_decrypt">Dịch ngược hàm fw_decrypt</h1>
<p>Tiếp theo, mình sẽ phân tích hàm <code>fw_decrypt</code> và dịch ngược nó lại.</p>
<blockquote>
<p><strong>Note</strong>: Code của hàm<code>fw_decrypt</code> khá là dài thế nên mình sẽ copy nó vào 1 block code thay vì chụp ảnh</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined8</span> <span style="color:#61afef;font-weight:bold">fw_decrypt</span>(<span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>,<span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">param_3</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">uVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">puVar2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#e06c75">decrypt_size</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#e06c75">uVar4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">__src</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">local_24</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">uStack_20</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">==</span> (<span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span>)<span style="color:#d19a66">0x0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0xffffffff</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xe</span>) <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#39;\x01&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> ((((<span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">0x29</span>) <span style="color:#56b6c2">||</span> (<span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">&lt;</span> (<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xd</span>) <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>) <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span>)) <span style="color:#56b6c2">||</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span>))) <span style="color:#56b6c2">||</span> ((<span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x28</span> <span style="color:#56b6c2">&amp;</span> <span style="color:#d19a66">0xf</span>) <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0xfffffffe</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">while</span> (<span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">ubuf</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0xa7</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x8b</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x2d</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_24</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">param_2</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">uStack_20</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">param_3</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">ecb128Decrypt</span>((<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span>)<span style="color:#e06c75">param_1</span>,(<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span>)<span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">decrypt_size</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">uVar4</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> (((<span style="color:#d19a66">0x28</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">uVar4</span>) <span style="color:#56b6c2">&amp;&amp;</span> ((<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xd</span>) <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>) <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">uVar4</span>)) <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xe</span>) <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#39;\0&#39;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">__src</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> (<span style="color:#e06c75">uint</span>)<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xd</span>) <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x24</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">memcpy</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_24</span>,<span style="color:#e06c75">__src</span>,<span style="color:#d19a66">4</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">puVar2</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span>)<span style="color:#61afef;font-weight:bold">cal_crc32</span>((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">__src</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span>,<span style="color:#e06c75">uVar4</span> <span style="color:#56b6c2">+</span> (<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">byte</span> <span style="color:#56b6c2">*</span>)((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0xd</span>) <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>) <span style="color:#56b6c2">*</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">4</span>,
</span></span><span style="display:flex;"><span>                                   <span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">puVar2</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">local_24</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">if</span> ((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">decrypt_size</span> <span style="color:#56b6c2">&lt;</span> (<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">uVar4</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0xfffffffb</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">uVar4</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">goto</span> <span style="color:#e06c75">LAB_0001191c</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0xfffffffc</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">uVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#e06c75">LAB_0001191c</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">CONCAT44</span>(<span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">uVar1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ở dòng này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">ecb128Decrypt</span>((<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span>)<span style="color:#e06c75">param_1</span>,(<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span>)<span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">decrypt_size</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>);
</span></span></code></pre></div><p>Bởi vì mình biết cách hàm <code>ecb128Decrypt</code> hoạt động, mình có thể thấy là tham số <code>decrypt_in</code> và <code>decrypt_out</code> có cùng 1 biến: <code>param_1</code>. Điều này có nghĩa là biến <code>param_1</code> được giải mã vào chính nó. Mình sẽ đặt tên <code>param_1</code> thành <code>fw_buffer</code> và đặt lại kiểu dữ liệu thành <code>uchar*</code>.</p>
<p>Hàm <code>ecb128Decrypt</code> cũng lấy 1 tham số gọi là <code>decrypt_size</code>, tham số này có dữ liệu từ <code>param_2</code> (ở dòng <code>decrypt_size = *param_2;</code>). Mình sẽ đặt tên của <code>param_2</code> thành <code>fw_buffer_size</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">ecb128Decrypt</span>(<span style="color:#e06c75">fw_buffer</span>,<span style="color:#e06c75">fw_buffer</span>,<span style="color:#e06c75">decrypt_size</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>);
</span></span></code></pre></div><p>Ở dòng điều kiện &ldquo;<em>if</em>&rdquo;, nó sẽ check xem <code>param_1</code> (<code>fw_buffer</code>) có giá trị <em>null</em> hay không. Nếu nó có giá trị là <em>null</em> thì biến <code>uVar2</code> sẽ được gán giá trị <em>0xffffffff</em>. Biến <code>uVar2</code> là biến đầu ra của hàm <code>fw_decrypt</code> thế nên mình sẽ đặt tên nó thành <code>return_value</code>.</p>
<p>Đặt <code>return_value</code> thành <em>0xffffffff</em> sẽ overflow biến này <code>return_value</code> thành 1 giá trị âm. Mình có thể check xem số này là số nào bằng cách đổi kiểu dữ liệu của <code>return_value</code> từ <code>uint</code> sang <code>int</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">fw_buffer</span> <span style="color:#56b6c2">==</span> (<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span>)<span style="color:#d19a66">0x0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">return_value</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nó sẽ đặt <code>return_value</code> thành <em>-1</em>, có nghĩa là fail trong C. Mình có thể suy ra kiểu dữ liệu của hàm <code>fw_decrypt</code> từ biến <code>uVar2</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">fw_decrypt</span>(<span style="color:#e06c75">uchar</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">fw_buffer</span>,<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">fw_buffer_size</span>,<span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">param_3</span>)
</span></span></code></pre></div><p>Hàm này đã trở nên dễ đọc hơn nhiều</p>
<p>Ở trong câu lệnh <em>if</em> ở trong câu lệnh <em>else if</em>, nó sẽ check lỗi và kích cỡ hàm không hợp lệ và trả về giá trị âm nếu không hợp lệ. Câu lệnh <em>else</em> sau đó nhìn nhìn khá thú vị, mình sẽ xem nó làm những gì:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">while</span> (<span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">ubuf</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0xa7</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x8b</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x2d</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_24</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">fw_buffer_size</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uStack_20</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">param_3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">ecb128Decrypt</span>(<span style="color:#e06c75">fw_buffer</span>,<span style="color:#e06c75">fw_buffer</span>,<span style="color:#e06c75">decrypt_size</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uVar4</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">fw_buffer</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (((<span style="color:#d19a66">0x28</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">uVar4</span>) <span style="color:#56b6c2">&amp;&amp;</span> (<span style="color:#e06c75">bVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">fw_buffer</span>[<span style="color:#d19a66">0xd</span>], (<span style="color:#e06c75">bVar1</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>) <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">uVar4</span>)) <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#e06c75">fw_buffer</span>[<span style="color:#d19a66">0xe</span>] <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#39;\0&#39;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">memcpy</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_24</span>,<span style="color:#e06c75">fw_buffer</span> <span style="color:#56b6c2">+</span> (<span style="color:#e06c75">uint</span>)<span style="color:#e06c75">bVar1</span> <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x24</span>,<span style="color:#d19a66">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">puVar2</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">uint</span> <span style="color:#56b6c2">*</span>)<span style="color:#61afef;font-weight:bold">cal_crc32</span>((<span style="color:#e5c07b">int</span>)(<span style="color:#e06c75">fw_buffer</span> <span style="color:#56b6c2">+</span> (<span style="color:#e06c75">uint</span>)<span style="color:#e06c75">bVar1</span> <span style="color:#56b6c2">*</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x24</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span>),
</span></span><span style="display:flex;"><span>                               <span style="color:#e06c75">uVar4</span> <span style="color:#56b6c2">+</span> (<span style="color:#e06c75">fw_buffer</span>[<span style="color:#d19a66">0xd</span>] <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>) <span style="color:#56b6c2">*</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">4</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">puVar2</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">local_24</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> ((<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">uVar4</span> <span style="color:#56b6c2">&lt;=</span> (<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">decrypt_size</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">*</span><span style="color:#e06c75">fw_buffer_size</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">uVar4</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">return</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">return_value</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Mình sẽ đi qua từng đoạn và phân tích nó:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">passwd</span><span style="color:#d19a66">.3309</span>;
</span></span></code></pre></div><p><code>passwd.3309</code> nhìn giống như 1 biến chứa mật khẩu. Biến này cũng được dùng cho tham số <code>decrypt_key</code> của hàm <code>ecb128Decrypt</code>. Biến <code>pbVar3</code> sẽ giữ giá trị của <code>passwd.3309</code> thế nên mình sẽ đặt tên <code>pbVar3</code> thành <code>password</code>.</p>
<p>Tiếp theo là vòng lặp <em>while</em>, biến <code>password</code> sẽ được biến đổi qua 1 vài thao tác <em>XOR</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">while</span> (<span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">ubuf</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0xa7</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x8b</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">2</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">0x2d</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span>[<span style="color:#d19a66">3</span>] <span style="color:#56b6c2">^</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pbVar3</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đây có thể là 1 phương thức &ldquo;làm mờ&rdquo; hoặc mã hóa. Mình sẽ thử mô phỏng vòng lặp này bằng cách viết lại vòng lặp này trong Python.</p>
<p>Đầu tiên thì mình sẽ cần lấy dữ liệu mà <code>passwd.3309</code> đang trỏ đến, mình có thể làm thế bằng cách nhìn trong cửa số <strong>Bytes</strong> của Ghidra:</p>

    <img src="/img/nport-firmware/nport-firmware-fw_decrypt-passwd-bytes.png"  alt="NPort firmware fw_decrypt passwd3309 byte"  class="center"  style="padding: 10px"  />


<p>Mình sẽ copy các byte được bôi đen vào 1 mảng trong Python:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e06c75">passwd</span> <span style="color:#56b6c2">=</span> [<span style="color:#d19a66">0x95</span>, <span style="color:#d19a66">0xb3</span>, <span style="color:#d19a66">0x15</span>, <span style="color:#d19a66">0x32</span>, <span style="color:#d19a66">0xe4</span>, <span style="color:#d19a66">0xe4</span>, <span style="color:#d19a66">0x43</span>, <span style="color:#d19a66">0x6b</span>, <span style="color:#d19a66">0x90</span>, <span style="color:#d19a66">0xbe</span>, <span style="color:#d19a66">0x1b</span>, <span style="color:#d19a66">0x31</span>, <span style="color:#d19a66">0xa7</span>, <span style="color:#d19a66">0x8b</span>, <span style="color:#d19a66">0x2d</span>, <span style="color:#d19a66">0x05</span>]
</span></span></code></pre></div><p>Mình sẽ làm lại vòng lặp <em>while</em> với các thao tác <em>XOR</em> như trong chương trình dịch ngược:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">while</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">passwd</span>)):
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0xa7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x8b</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">2</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x2d</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">3</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">5</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+=</span> <span style="color:#d19a66">4</span>
</span></span></code></pre></div><p>Sau đó mình có thể in ra mật khẩu:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#98c379">&#34;&#34;</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">join</span>(<span style="color:#e5c07b">chr</span>(<span style="color:#e06c75">byte</span>) <span style="color:#c678dd">for</span> <span style="color:#e06c75">byte</span> <span style="color:#56b6c2">in</span> <span style="color:#e06c75">passwd</span>))
</span></span></code></pre></div><p>Đây là chương trình Python full:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e06c75">passwd</span> <span style="color:#56b6c2">=</span> [<span style="color:#d19a66">0x95</span>, <span style="color:#d19a66">0xb3</span>, <span style="color:#d19a66">0x15</span>, <span style="color:#d19a66">0x32</span>, <span style="color:#d19a66">0xe4</span>, <span style="color:#d19a66">0xe4</span>, <span style="color:#d19a66">0x43</span>, <span style="color:#d19a66">0x6b</span>, <span style="color:#d19a66">0x90</span>, <span style="color:#d19a66">0xbe</span>, <span style="color:#d19a66">0x1b</span>, <span style="color:#d19a66">0x31</span>, <span style="color:#d19a66">0xa7</span>, <span style="color:#d19a66">0x8b</span>, <span style="color:#d19a66">0x2d</span>, <span style="color:#d19a66">0x05</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">while</span> (<span style="color:#e06c75">i</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">passwd</span>)):
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0xa7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x8b</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">2</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">0x2d</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">passwd</span>[<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">3</span>] <span style="color:#56b6c2">^=</span> <span style="color:#d19a66">5</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">i</span> <span style="color:#56b6c2">+=</span> <span style="color:#d19a66">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#98c379">&#34;&#34;</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">join</span>(<span style="color:#e5c07b">chr</span>(<span style="color:#e06c75">byte</span>) <span style="color:#c678dd">for</span> <span style="color:#e06c75">byte</span> <span style="color:#56b6c2">in</span> <span style="color:#e06c75">passwd</span>))
</span></span></code></pre></div><p>Khi mình chạy chương trình Python này, nó sẽ in ra cái này:</p>

    <img src="/img/nport-firmware/nport-firmware-fw_decrypt-python-output.png"  alt="NPort firmware fw_decrypt vòng lặp while trong python"  class="center"  style="padding: 10px"  />


<p>Thế là mình được khóa giải mã AES cho chương trình này là &ldquo;<em>2887Conn7564</em>&rdquo;. Mình có thể sử dụng khóa này để giải mã firmware. Trước hết thì mình cần chuyển khóa này thành mã hex:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e5c07b">print</span>(<span style="color:#98c379">&#34;&#34;</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">join</span>(<span style="color:#e5c07b">hex</span>(<span style="color:#e06c75">byte</span>)[<span style="color:#d19a66">2</span>:] <span style="color:#c678dd">for</span> <span style="color:#e06c75">byte</span> <span style="color:#56b6c2">in</span> <span style="color:#e06c75">passwd</span>))
</span></span></code></pre></div><p>Dòng này sẽ cho ra kết quả là <em>32383837436f6e6e373536340000</em></p>
<h1 id="giải-mã-phần-mềm">Giải mã phần mềm</h1>
<p>Làm thế nào để mình có thể giải mã firmware này với khóa mình vừa lấy được?</p>
<p>Mình có thể dùng <em>OpenSSL</em>. Câu lệnh <code>openssl</code> có hỗ trợ mã hóa AES 128-bit ở chế độ ECB thế nên mình sẽ sử dụng nó.</p>
<p>Trước khi mình giải mã, khi mà mình dịch ngược hàm <code>ecb128Decrypt</code> và dùng câu lệnh <code>hexdump</code>, mình biết được là firmware đã bị mã hóa này có khoảng <em>0x28</em> byte đệm (40 byte trong số nguyên)</p>
<p>Thế nên mình phải loại bỏ các byte đệm đó, nếu không thì nó sẽ cố giải mã các byte đệm đó, tạo ra dữ liệu xấu. Mình sẽ dùng câu lệnh <code>dd</code> cho việc này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dd <span style="color:#c678dd">if</span><span style="color:#56b6c2">=</span>moxa-nport-w2150a-w2250a-series-firmware-v2.2.rom <span style="color:#e06c75">of</span><span style="color:#56b6c2">=</span>firmware-offseted.encrypted <span style="color:#e06c75">bs</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span> <span style="color:#e06c75">skip</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">40</span>
</span></span><span style="display:flex;"><span>8874768+0 records in
</span></span><span style="display:flex;"><span>8874768+0 records out
</span></span><span style="display:flex;"><span><span style="color:#d19a66">8874768</span> bytes transferred in 54.281718 secs <span style="color:#56b6c2">(</span><span style="color:#d19a66">163495</span> bytes/sec<span style="color:#56b6c2">)</span>
</span></span></code></pre></div><blockquote>
<p><strong>Note</strong>: <code>bs</code> có nghĩa là kích cỡ khối, <code>skip</code> có nghĩa là số byte để skip</p>
</blockquote>
<p>Bây giờ mình có thể dùng <code>openssl</code> để giải mã file <code>firmware-offseted.encrypted</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl aes-128-ecb -d -K <span style="color:#98c379">&#34;32383837436f6e6e373536340000&#34;</span> -in firmware-offseted.encrypted -out firmware.decrypted
</span></span></code></pre></div><p>Câu lệnh này sẽ cho ra file <code>firmware.decrypted</code>. Nếu như mình chạy câu lệnh <code>binwalk</code> lên file đã được giải mã này thì nó sẽ ra:</p>

    <img src="/img/nport-firmware/nport-firmware-firmware-decrypted-openssl.png"  alt="NPort firmware đã được giải mã binwalk"  class="center"  style="padding: 10px"  />


<p>Mình sẽ giải nén file này ra <code>_firmware.decrypted.extracted</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>binwalk -e firmware.decrypted
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">cd</span> _firmware.decrypted.extracted
</span></span></code></pre></div><p>Cho các folder <code>squashfs-root</code> quyền thực thi:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x -R squashfs-root*
</span></span></code></pre></div><p>Và thế là mình có quyền truy cập vào firmware phiên bản <em>2.2</em> của thiết bị này:</p>

    <img src="/img/nport-firmware/nport-firmware-firmware-decrypted-filesystem.png"  alt="NPort firmware hệ thống file đã được giải mã"  class="center"  style="padding: 10px"  />


<h1 id="kết-luận">Kết luận</h1>
<p>Đó là cách mình dịch ngược và giải mã 1 firmware đã được mã hóa. Mình học được nhiều về cách phân tích firmware để tìm ra lỗ hổng và cách tấn công các lỗ hổng đó.</p>
<blockquote>
<p>Các file Ghidra và Python được host ở <a href="https://github.com/namberino/NPort-firmware-decrypt">đây</a></p>
</blockquote>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://namberino.github.io/en/tags/b%E1%BA%A3o-m%E1%BA%ADt/">bảo mật</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/hack/">hack</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/d%E1%BB%8Bch-ng%C6%B0%E1%BB%A3c/">dịch ngược</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/l%E1%BA%ADp-tr%C3%ACnh/">lập trình</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js" integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script>





    </body>
</html>
